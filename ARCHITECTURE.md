# Architecture Overview

## Project Structure

```
poc_ios_modularization/
├── shared/                          # Kotlin Multiplatform Module
│   ├── src/
│   │   ├── commonMain/             # Shared code (all platforms)
│   │   │   └── kotlin/
│   │   │       └── com/example/shared/
│   │   │           └── Greeting.kt # Example shared code
│   │   └── iosMain/                # iOS-specific implementations
│   │       └── kotlin/
│   │           └── com/example/shared/
│   │               └── Platform.kt  # iOS platform implementation
│   └── build.gradle.kts            # KMP module build configuration
│
├── iosApp/                          # iOS Application
│   ├── iosApp/
│   │   ├── iOSApp.swift            # App entry point
│   │   ├── ContentView.swift       # UI using KMP module
│   │   ├── Info.plist              # iOS app configuration
│   │   └── Assets.xcassets/        # iOS assets
│   └── iosApp.xcodeproj/           # Xcode project
│       └── project.pbxproj         # Project configuration with KMP framework link
│
├── build.gradle.kts                # Root Gradle configuration
├── settings.gradle.kts             # Gradle project settings
└── gradlew                         # Gradle wrapper script
```

## Component Interaction

```
┌─────────────────────────────────────────────────┐
│          iOS Application (SwiftUI)              │
│                                                 │
│  ┌─────────────────────────────────────────┐   │
│  │       ContentView.swift                 │   │
│  │  • Uses Greeting class from shared      │   │
│  │  • Displays greeting text                │   │
│  └─────────────────────────────────────────┘   │
│                     │                           │
│                     │ imports shared            │
│                     ▼                           │
└─────────────────────────────────────────────────┘
                      │
                      │ Links to
                      ▼
┌─────────────────────────────────────────────────┐
│     KMP shared.framework (iOS Binary)           │
│                                                 │
│  Generated by Gradle during Xcode build:        │
│  ./gradlew :shared:embedAndSignAppleFramework   │
│                                                 │
└─────────────────────────────────────────────────┘
                      │
                      │ Built from
                      ▼
┌─────────────────────────────────────────────────┐
│     Kotlin Multiplatform Module                 │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │          commonMain                      │  │
│  │  • Greeting.kt (shared logic)            │  │
│  │  • Platform interface                    │  │
│  └──────────────────────────────────────────┘  │
│                     │                           │
│                     │ expect/actual             │
│                     ▼                           │
│  ┌──────────────────────────────────────────┐  │
│  │           iosMain                        │  │
│  │  • Platform.kt (iOS implementation)      │  │
│  │  • Uses UIDevice for platform info       │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
└─────────────────────────────────────────────────┘
```

## Build Process

1. **Xcode Build Triggered**: User builds the iOS app in Xcode
2. **Run Script Phase**: Xcode executes the build script in project.pbxproj
3. **Gradle Task Execution**: Script runs `./gradlew :shared:embedAndSignAppleFrameworkForXcode`
4. **KMP Compilation**: Gradle compiles Kotlin code for the appropriate iOS target:
   - `iosArm64` for physical devices
   - `iosSimulatorArm64` or `iosX64` for simulators
5. **Framework Generation**: KMP produces `shared.framework`
6. **Framework Embedding**: Framework is copied to the appropriate build directory
7. **iOS Linking**: Xcode links the iOS app with the framework
8. **App Bundle Creation**: Final iOS app bundle is created with embedded framework

## Key Configuration Files

### shared/build.gradle.kts
- Defines iOS targets (iosArm64, iosX64, iosSimulatorArm64)
- Configures framework generation (static framework named "shared")
- Sets up source sets with expect/actual pattern

### iosApp.xcodeproj/project.pbxproj
- **Build Script Phase**: Calls Gradle to build the framework
- **Framework Search Paths**: Points to `shared/build/xcodegen/{Debug|Release}`
- **Linker Flags**: Links the `shared` framework

## Module Communication

The iOS app communicates with the KMP module through:
1. **Import statement**: `import shared` in Swift files
2. **Direct API calls**: Instantiate Kotlin classes and call methods
3. **Type mapping**: Kotlin types are automatically mapped to Swift/Objective-C types

Example:
```swift
import shared

// Create instance of Kotlin class
let greeting = Greeting()

// Call Kotlin method
let message = greeting.greet()  // Returns: "Hello from iOS {version}!"
```
